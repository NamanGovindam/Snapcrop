<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Tools: Converter & Cropper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 30px;
            overflow: hidden;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .tool-toggle {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .toggle-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .toggle-btn:hover {
            background-color: #2980b9;
        }
        
        .toggle-btn.active {
            background-color: #2c3e50;
        }
        
        .back-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            margin-bottom: 15px;
            display: none;
        }
        
        .back-btn:hover {
            background-color: #c0392b;
        }
        
        /* Converter Styles */
        .converter-section {
            display: block;
        }
        
        .cropper-section {
            display: none;
        }
        
        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
            background-color: #f8fafc;
            cursor: pointer;
        }
        
        .upload-area:hover, .upload-area.drag-over {
            background-color: #e3f2fd;
            border-color: #2980b9;
        }
        
        .upload-icon {
            font-size: 60px;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .file-input {
            display: none;
        }
        
        .browse-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
        }
        
        .browse-btn:hover {
            background-color: #2980b9;
        }
        
        .format-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
        }
        
        .format-option {
            background-color: #ecf0f1;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .format-option:hover {
            background-color: #d5dbdb;
        }
        
        .format-option.active {
            background-color: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .preview-item {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        
        .preview-item:hover {
            transform: translateY(-5px);
        }
        
        .preview-img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-bottom: 1px solid #eee;
        }
        
        .preview-info {
            padding: 15px;
        }
        
        .preview-name {
            font-weight: 600;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .preview-size {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .convert-btn, .download-all-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .convert-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        .convert-btn:hover {
            background-color: #27ae60;
        }
        
        .convert-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .download-all-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .download-all-btn:hover {
            background-color: #c0392b;
        }
        
        .download-all-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .converted-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .converted-item {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .converted-img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-bottom: 1px solid #eee;
        }
        
        .converted-info {
            padding: 15px;
        }
        
        .converted-name {
            font-weight: 600;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .converted-format {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .download-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            width: 100%;
            transition: background-color 0.3s;
        }
        
        .download-btn:hover {
            background-color: #2980b9;
        }
        
        .status {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .hidden {
            display: none;
        }
        
        /* Cropper Styles */
        .cropper-section {
            text-align: center;
        }
        
        .cropper-canvas {
            border: 1px solid #ccc;
            margin-top: 10px;
            max-width: 95%;
            height: auto;
            touch-action: none;
        }
        
        .cropper-controls {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
        }
        
        .cropper-btn, .cropper-range {
            padding: 6px 10px;
            font-size: 13px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
        
        .cropper-btn { 
            background: #007bff; 
            color: white; 
        }
        
        .cropper-btn:hover { 
            background: #0056b3; 
        }
        
        .cropper-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .filter-group label { 
            display:inline-block; 
            margin:0 6px; 
        }
        
        .cropper-preview {
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .image-preview, .converted-images {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .actions {
                flex-direction: column;
            }
            
            .cropper-controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Image Tools: Converter & Cropper</h1>
            <p class="subtitle">Convert images to different formats or crop and edit them</p>
        </header>
        
        <div class="tool-toggle">
            <button class="toggle-btn active" id="converterToggle">Image Converter</button>
            <button class="toggle-btn" id="cropperToggle">Smart Cropper</button>
        </div>
        
        <!-- Converter Section -->
        <div class="converter-section" id="converterSection">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <p class="upload-text">Drag & drop your images here or click to browse</p>
                <button class="browse-btn">Browse Files</button>
                <input type="file" class="file-input" id="fileInput" accept="image/*" multiple>
            </div>
            
            <div class="format-options">
                <div class="format-option" data-format="jpg">JPG</div>
                <div class="format-option" data-format="jpeg">JPEG</div>
                <div class="format-option" data-format="png">PNG</div>
                <div class="format-option" data-format="webp">WebP</div>
                <div class="format-option" data-format="bmp">BMP</div>
            </div>
            
            <div class="image-preview" id="imagePreview"></div>
            
            <div class="actions">
                <button class="convert-btn" id="convertBtn" disabled>Convert Images</button>
                <button class="download-all-btn" id="downloadAllBtn" disabled>Download All</button>
            </div>
            
            <div class="status hidden" id="statusMessage"></div>
            
            <div class="converted-images" id="convertedImages"></div>
        </div>
        
        <!-- Cropper Section -->
        <div class="cropper-section" id="cropperSection">
            <button class="back-btn" id="backBtn">‚Üê Back to Converter</button>
            
            <h2>Perfect Smart Cropper</h2>
            <input type="file" id="cropperFileInput" accept="image/*">
            <p>(Or paste an image directly)</p>
            
            <div class="cropper-controls">
                <button class="cropper-btn" id="rotateLeft">‚ü≤ Rotate</button>
                <button class="cropper-btn" id="rotateRight">‚ü≥ Rotate</button>
                <button class="cropper-btn" id="flipX">‚Üî Mirror X</button>
                <button class="cropper-btn" id="flipY">‚Üï Mirror Y</button>
                <button class="cropper-btn" id="bwBtn">‚ö´ B&W</button>
                <button class="cropper-btn" id="cropBtn" disabled>‚úÇÔ∏è Crop</button>
                <button class="cropper-btn" id="postRotateLeft" disabled>‚ü≤ Rotate Cropped</button>
                <button class="cropper-btn" id="postRotateRight" disabled>‚ü≥ Rotate Cropped</button>
                <button class="cropper-btn" id="waterBtn" disabled>üíß Watermark</button>
                <button class="cropper-btn" id="downloadBtn" disabled>‚¨áÔ∏è Download</button>
                <button class="cropper-btn" id="copyBtn" disabled>üìã Copy</button>
            </div>
            
            <div class="cropper-controls filter-group">
                <label>B <input type="range" id="brightness" min="0.5" max="2" step="0.1" value="1"></label>
                <label>C <input type="range" id="contrast" min="0.5" max="2" step="0.1" value="1"></label>
                <label>Blur <input type="range" id="blur" min="0" max="10" step="0.5" value="0"></label>
            </div>
            
            <canvas id="canvas" class="cropper-canvas"></canvas>
            <div class="cropper-preview">
                <h4>Cropped Preview</h4>
                <canvas id="preview" class="cropper-canvas"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Tool Toggle Functionality
        const converterToggle = document.getElementById('converterToggle');
        const cropperToggle = document.getElementById('cropperToggle');
        const converterSection = document.getElementById('converterSection');
        const cropperSection = document.getElementById('cropperSection');
        const backBtn = document.getElementById('backBtn');
        
        converterToggle.addEventListener('click', () => {
            converterToggle.classList.add('active');
            cropperToggle.classList.remove('active');
            converterSection.style.display = 'block';
            cropperSection.style.display = 'none';
            backBtn.style.display = 'none';
        });
        
        cropperToggle.addEventListener('click', () => {
            cropperToggle.classList.add('active');
            converterToggle.classList.remove('active');
            converterSection.style.display = 'none';
            cropperSection.style.display = 'block';
            backBtn.style.display = 'block';
        });
        
        backBtn.addEventListener('click', () => {
            converterToggle.classList.add('active');
            cropperToggle.classList.remove('active');
            converterSection.style.display = 'block';
            cropperSection.style.display = 'none';
            backBtn.style.display = 'none';
        });
        
        // Image Converter Code
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const imagePreview = document.getElementById('imagePreview');
            const formatOptions = document.querySelectorAll('.format-option');
            const convertBtn = document.getElementById('convertBtn');
            const downloadAllBtn = document.getElementById('downloadAllBtn');
            const convertedImages = document.getElementById('convertedImages');
            const statusMessage = document.getElementById('statusMessage');
            
            let selectedFiles = [];
            let selectedFormat = 'jpg';
            let convertedFiles = [];
            
            // Upload area click event
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // File input change event
            fileInput.addEventListener('change', handleFileSelect);
            
            // Drag and drop events
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length) {
                    handleFiles(e.dataTransfer.files);
                }
            });
            
            // Paste event for converter
            document.addEventListener('paste', (e) => {
                const item = [...e.clipboardData.items].find(i => i.type.startsWith('image/'));
                if (item) {
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = ev => {
                        const file = new File([blob], 'pasted-image.png', { type: 'image/png' });
                        handleFiles([file]);
                    };
                    reader.readAsArrayBuffer(blob);
                }
            });
            
            // Format selection
            formatOptions.forEach(option => {
                option.addEventListener('click', () => {
                    formatOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedFormat = option.getAttribute('data-format');
                });
            });
            
            // Set default format
            formatOptions[0].classList.add('active');
            
            // Convert button event
            convertBtn.addEventListener('click', convertImages);
            
            // Download all button event
            downloadAllBtn.addEventListener('click', downloadAll);
            
            function handleFileSelect(e) {
                handleFiles(e.target.files);
            }
            
            function handleFiles(files) {
                selectedFiles = Array.from(files);
                
                // Clear previous previews
                imagePreview.innerHTML = '';
                
                if (selectedFiles.length === 0) {
                    convertBtn.disabled = true;
                    return;
                }
                
                // Enable convert button
                convertBtn.disabled = false;
                
                // Create preview for each file
                selectedFiles.forEach((file, index) => {
                    if (!file.type.match('image.*')) {
                        showStatus('Please upload only image files.', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'preview-item';
                        
                        const img = document.createElement('img');
                        img.className = 'preview-img';
                        img.src = e.target.result;
                        
                        const previewInfo = document.createElement('div');
                        previewInfo.className = 'preview-info';
                        
                        const fileName = document.createElement('div');
                        fileName.className = 'preview-name';
                        fileName.textContent = file.name;
                        
                        const fileSize = document.createElement('div');
                        fileSize.className = 'preview-size';
                        fileSize.textContent = formatFileSize(file.size);
                        
                        previewInfo.appendChild(fileName);
                        previewInfo.appendChild(fileSize);
                        previewItem.appendChild(img);
                        previewItem.appendChild(previewInfo);
                        
                        imagePreview.appendChild(previewItem);
                    };
                    
                    reader.readAsDataURL(file);
                });
                
                showStatus(`Loaded ${selectedFiles.length} image(s) for conversion.`, 'success');
            }
            
            function convertImages() {
                if (selectedFiles.length === 0) {
                    showStatus('Please upload images first.', 'error');
                    return;
                }
                
                // Clear previous conversions
                convertedImages.innerHTML = '';
                convertedFiles = [];
                
                // Convert each image
                selectedFiles.forEach(file => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            
                            let mimeType;
                            switch(selectedFormat) {
                                case 'jpg':
                                case 'jpeg':
                                    mimeType = 'image/jpeg';
                                    break;
                                case 'png':
                                    mimeType = 'image/png';
                                    break;
                                case 'webp':
                                    mimeType = 'image/webp';
                                    break;
                                case 'bmp':
                                    mimeType = 'image/bmp';
                                    break;
                                default:
                                    mimeType = 'image/jpeg';
                            }
                            
                            // Convert to data URL with selected format
                            const dataURL = canvas.toDataURL(mimeType);
                            
                            // Create download link
                            const convertedItem = document.createElement('div');
                            convertedItem.className = 'converted-item';
                            
                            const convertedImg = document.createElement('img');
                            convertedImg.className = 'converted-img';
                            convertedImg.src = dataURL;
                            
                            const convertedInfo = document.createElement('div');
                            convertedInfo.className = 'converted-info';
                            
                            const convertedName = document.createElement('div');
                            convertedName.className = 'converted-name';
                            convertedName.textContent = file.name.replace(/\.[^/.]+$/, "") + '.' + selectedFormat;
                            
                            const convertedFormat = document.createElement('div');
                            convertedFormat.className = 'converted-format';
                            convertedFormat.textContent = `Format: ${selectedFormat.toUpperCase()}`;
                            
                            const downloadBtn = document.createElement('button');
                            downloadBtn.className = 'download-btn';
                            downloadBtn.textContent = 'Download';
                            downloadBtn.addEventListener('click', () => {
                                downloadImage(dataURL, convertedName.textContent);
                            });
                            
                            convertedInfo.appendChild(convertedName);
                            convertedInfo.appendChild(convertedFormat);
                            convertedInfo.appendChild(downloadBtn);
                            convertedItem.appendChild(convertedImg);
                            convertedItem.appendChild(convertedInfo);
                            
                            convertedImages.appendChild(convertedItem);
                            
                            // Store converted file info
                            convertedFiles.push({
                                dataURL: dataURL,
                                name: convertedName.textContent
                            });
                            
                            // Enable download all button if we have converted files
                            if (convertedFiles.length > 0) {
                                downloadAllBtn.disabled = false;
                            }
                        };
                        
                        img.src = e.target.result;
                    };
                    
                    reader.readAsDataURL(file);
                });
                
                showStatus(`Conversion to ${selectedFormat.toUpperCase()} completed!`, 'success');
            }
            
            function downloadImage(dataURL, filename) {
                const link = document.createElement('a');
                link.href = dataURL;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            function downloadAll() {
                if (convertedFiles.length === 0) {
                    showStatus('No converted images to download.', 'error');
                    return;
                }
                
                convertedFiles.forEach(file => {
                    downloadImage(file.dataURL, file.name);
                });
                
                showStatus(`Downloaded ${convertedFiles.length} image(s).`, 'success');
            }
            
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            function showStatus(message, type) {
                statusMessage.textContent = message;
                statusMessage.className = `status ${type}`;
                statusMessage.classList.remove('hidden');
                
                // Hide status after 5 seconds
                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                }, 5000);
            }
        });
        
        // Smart Cropper Code
        const cropperFileInput = document.getElementById("cropperFileInput");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const preview = document.getElementById("preview");
        const cropBtn = document.getElementById("cropBtn");
        const downloadBtn = document.getElementById("downloadBtn");
        const copyBtn = document.getElementById("copyBtn");
        const waterBtn = document.getElementById("waterBtn");
        const bwBtn = document.getElementById("bwBtn");
        const postRotateLeft = document.getElementById("postRotateLeft");
        const postRotateRight = document.getElementById("postRotateRight");
        const brightness = document.getElementById("brightness");
        const contrast = document.getElementById("contrast");
        const blur = document.getElementById("blur");

        let img = new Image();
        let points = [];
        let draggingPoint = -1;
        const pointRadius = 8;
        let rotation = 0, flipX = 1, flipY = 1;
        let croppedCanvas, postRotation = 0;
        let isBlackWhite = false;

        function fitCanvas(){
            const rad = Math.abs(rotation % 180) * Math.PI / 180;
            const sin = Math.abs(Math.sin(rad)), cos = Math.abs(Math.cos(rad));
            canvas.width = img.width * cos + img.height * sin;
            canvas.height = img.width * sin + img.height * cos;
        }

        function relToCanvas(p) { return {x: p.x * canvas.width, y: p.y * canvas.height}; }
        function canvasToRel(x, y) { return {x: x / canvas.width, y: y / canvas.height}; }

        function drawImage(){
            if(!img.width) return;
            fitCanvas();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(rotation * Math.PI / 180);
            ctx.scale(flipX, flipY);
            
            // Apply black and white filter if enabled
            if (isBlackWhite) {
                ctx.filter = "grayscale(100%)";
            } else {
                ctx.filter = "none";
            }
            
            ctx.drawImage(img, -img.width / 2, -img.height / 2);
            ctx.restore();

            if(points.length){
                ctx.fillStyle = "rgba(255,0,0,0.6)";
                ctx.strokeStyle = "red";
                ctx.lineWidth = 2;
                ctx.beginPath();
                const p0 = relToCanvas(points[0]);
                ctx.moveTo(p0.x, p0.y);
                for(let i = 1; i < points.length; i++){
                    const p = relToCanvas(points[i]);
                    ctx.lineTo(p.x, p.y);
                }
                ctx.closePath(); ctx.stroke();
                for(let p of points){
                    const pt = relToCanvas(p);
                    ctx.beginPath(); ctx.arc(pt.x, pt.y, pointRadius, 0, Math.PI * 2); ctx.fill();
                }
            }
        }

        canvas.addEventListener("mousedown", startDrag);
        canvas.addEventListener("touchstart", e => startDrag(e.touches[0]));
        canvas.addEventListener("mousemove", moveDrag);
        canvas.addEventListener("touchmove", e => moveDrag(e.touches[0]));
        canvas.addEventListener("mouseup", endDrag);
        canvas.addEventListener("mouseleave", endDrag);
        canvas.addEventListener("touchend", endDrag);

        function startDrag(e){
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left, my = e.clientY - rect.top;
            draggingPoint = points.findIndex(p => {
                const pt = relToCanvas(p);
                return Math.hypot(pt.x - mx, pt.y - my) < pointRadius;
            });
        }
        
        function moveDrag(e){
            if(draggingPoint >= 0){
                const rect = canvas.getBoundingClientRect();
                points[draggingPoint] = canvasToRel(e.clientX - rect.left, e.clientY - rect.top);
                drawImage();
            }
        }
        
        function endDrag(){ draggingPoint = -1; }

        cropperFileInput.addEventListener("change", e => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = ev => loadImage(ev.target.result);
            reader.readAsDataURL(file);
        });
        
        // Paste event for cropper
        document.addEventListener("paste", e => {
            const item = [...e.clipboardData.items].find(i => i.type.startsWith("image/"));
            if(item){
                const blob = item.getAsFile();
                const reader = new FileReader();
                reader.onload = ev => loadImage(ev.target.result);
                reader.readAsDataURL(blob);
            }
        });

        function loadImage(src){
            img = new Image();
            img.onload = () => {
                rotation = 0; flipX = 1; flipY = 1; postRotation = 0;
                isBlackWhite = false;
                points = [{x:0.2,y:0.2},{x:0.8,y:0.2},{x:0.9,y:0.8},{x:0.1,y:0.8}];
                drawImage(); 
                cropBtn.disabled = false;
                bwBtn.disabled = false;
            };
            img.src = src;
        }

        document.getElementById("rotateLeft").onclick = () => { rotation -= 90; drawImage(); };
        document.getElementById("rotateRight").onclick = () => { rotation += 90; drawImage(); };
        document.getElementById("flipX").onclick = () => { flipX *= -1; drawImage(); };
        document.getElementById("flipY").onclick = () => { flipY *= -1; drawImage(); };
        bwBtn.onclick = () => { 
            isBlackWhite = !isBlackWhite; 
            bwBtn.style.backgroundColor = isBlackWhite ? "#2c3e50" : "#007bff";
            drawImage(); 
        };

        cropBtn.onclick = () => {
            if(!img.width) return;
            fitCanvas();
            const temp = document.createElement("canvas");
            temp.width = canvas.width; temp.height = canvas.height;
            const tctx = temp.getContext("2d");
            tctx.save();
            tctx.translate(temp.width / 2, temp.height / 2);
            tctx.rotate(rotation * Math.PI / 180);
            tctx.scale(flipX, flipY);
            
            // Apply black and white filter if enabled
            if (isBlackWhite) {
                tctx.filter = "grayscale(100%)";
            } else {
                tctx.filter = "none";
            }
            
            tctx.drawImage(img, -img.width / 2, -img.height / 2);
            tctx.restore();

            const mask = document.createElement("canvas");
            mask.width = temp.width; mask.height = temp.height;
            const mctx = mask.getContext("2d");
            mctx.drawImage(tctx.canvas, 0, 0);
            mctx.beginPath();
            const p0 = relToCanvas(points[0]);
            mctx.moveTo(p0.x, p0.y);
            for(let i = 1; i < points.length; i++){
                const p = relToCanvas(points[i]); mctx.lineTo(p.x, p.y);
            }
            mctx.closePath();
            mctx.globalCompositeOperation = "destination-in";
            mctx.fill();

            // compute bounding box of polygon
            const xs = points.map(p => relToCanvas(p).x);
            const ys = points.map(p => relToCanvas(p).y);
            const minX = Math.min(...xs), maxX = Math.max(...xs);
            const minY = Math.min(...ys), maxY = Math.max(...ys);
            const w = maxX - minX, h = maxY - minY;

            // extract trimmed region only
            const trimmed = document.createElement("canvas");
            trimmed.width = w; trimmed.height = h;
            trimmed.getContext("2d").drawImage(mask, minX, minY, w, h, 0, 0, w, h);

            croppedCanvas = trimmed;
            drawCroppedPreview();
            postRotateLeft.disabled = postRotateRight.disabled =
            waterBtn.disabled = downloadBtn.disabled = copyBtn.disabled = false;
        };

        function drawCroppedPreview(){
            if(!croppedCanvas) return;
            const pctx = preview.getContext("2d");
            const w = croppedCanvas.width, h = croppedCanvas.height;
            const rad = postRotation * Math.PI / 180;
            const sin = Math.abs(Math.sin(rad)), cos = Math.abs(Math.cos(rad));
            const newW = w * cos + h * sin, newH = w * sin + h * cos;
            preview.width = newW; preview.height = newH;
            pctx.clearRect(0, 0, newW, newH);
            pctx.save();
            pctx.translate(newW / 2, newH / 2);
            pctx.rotate(rad);
            pctx.filter = `brightness(${brightness.value}) contrast(${contrast.value}) blur(${blur.value}px)`;
            pctx.drawImage(croppedCanvas, -w / 2, -h / 2);
            pctx.restore();
        }

        postRotateLeft.onclick = () => { postRotation -= 90; drawCroppedPreview(); };
        postRotateRight.onclick = () => { postRotation += 90; drawCroppedPreview(); };
        brightness.oninput = contrast.oninput = blur.oninput = drawCroppedPreview;

        waterBtn.onclick = () => {
            const pctx = preview.getContext("2d");
            pctx.save();
            pctx.font = "30px Arial";
            pctx.fillStyle = "rgba(255,255,255,0.6)";
            pctx.textAlign = "right";
            pctx.fillText("WATERMARK", preview.width - 10, preview.height - 10);
            pctx.restore();
        };

        downloadBtn.onclick = () => {
            const link = document.createElement("a");
            link.download = "cropped.png";
            link.href = preview.toDataURL("image/png");
            link.click();
        };
        
        copyBtn.onclick = () => {
            preview.toBlob(async blob => {
                try{
                    await navigator.clipboard.write([new ClipboardItem({"image/png": blob})]);
                    alert("‚úÖ Copied to clipboard!");
                }catch(e){ alert("‚ùå Copy failed: " + e); }
            });
        };
    </script>
</body>
</html>
